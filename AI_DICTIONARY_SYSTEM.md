# AI词典解说系统设计文档

## 概述

AI解说功能已从简单的翻译工具升级为专业的日语词典查询系统。系统现在能够智能识别查询类型（单词/句子），并返回规范化的词典条目格式。

## 核心设计理念

### 1. 词典化输出
- **不解释用户输入**：系统不直接解释用户输入的词，而是将输入映射到标准的日语词条
- **规范化格式**：所有输出遵循专业词典格式（見出し語、読み、品詞、義項等）
- **日语为主体**：词条本身用日语，释义用目标语言（中文/英文/日文）

### 2. 多语言输入支持
- **中文输入** → 映射到对应的日语词条（如"中午" → 「正午」「昼」）
- **英文输入** → 映射到对应的日语词条（如"eat" → 「食べる」「食う」）
- **日文输入** → 直接查找词条

### 3. 查询类型识别

#### Word（单词查询）
输入单个词或短语时，返回：
- 見出し語（日语词条）
- 読み（假名）+ ローマ字（可选）
- 品詞（词性：動詞・名詞・形容動詞等）
- 義項（释义，最多3条，每条≤30字）
- 用例（例句，可选）
- 注意点（使用注意，可选）

#### Sentence（句子解析）
输入完整句子时，返回：
- 逐词解析（词、读音、词义、语法作用）
- 语法点（句子中的语法现象）
- 整句翻译

#### NotFound（未收录）
找不到匹配词条时：
- 明确标注「未収録」
- 尝试提供最接近的候选词条（1条）
- 简要说明可能原因

## 数据结构

### LLMResult
```swift
{
  "queryType": "word" | "sentence" | "notFound",
  "entries": [LLMDictEntry],
  "sentenceAnalysis": LLMSentenceAnalysis?
}
```

### LLMDictEntry（词条）
```swift
{
  "headword": "食べる",           // 見出し語
  "reading": "たべる",            // 假名
  "romaji": "taberu",            // 罗马字（可选）
  "partOfSpeech": "動詞",        // 品词
  "senses": [                    // 义项（最多3条）
    "吃，食用",
    "生活，谋生"
  ],
  "examples": [                  // 用例（可选）
    {
      "japanese": "朝ごはんを食べる",
      "translation": "吃早饭"
    }
  ],
  "notes": [                     // 注意点（可选）
    "口语常用"
  ]
}
```

### LLMSentenceAnalysis（句子解析）
```swift
{
  "wordBreakdown": [
    {
      "word": "今日",
      "reading": "きょう",
      "meaning": "今天",
      "grammaticalRole": "时间名词"
    }
  ],
  "grammar": ["は标记主题", "そう表推测"],
  "translation": "今天好像要下雨"
}
```

## AI提示词策略

### 核心指令
1. **角色定位**：你是日语词典系统，不是翻译器
2. **任务明确**：映射输入到日语词条，而非解释输入本身
3. **格式严格**：只输出JSON，不要额外文字
4. **语言分层**：
   - 词条主体 → 日语
   - 解释文字 → ui_lang（zh-Hans/en/ja）

### 质量控制
- 每个词条最多3个义项
- 每个义项不超过30字
- 例句不超过20个日文词
- 多候选时按现代通用度排序（常用 > 文語 > 方言）
- 最多返回top_k=3个词条

### 失败处理
- 高置信度词条未找到 → 返回「未収録」
- 提供1个最接近的候选词条
- 说明可能原因（拼写错误/混合语言/造词等）
- **绝不编造新词**

## UI展示层

### 词条展示（Word）
```
📕 词典查询

食べる  たべる  [taberu]
━━━━━━━━━━━━━━━━━━
[動詞]

1. 吃，食用
2. 生活，谋生

用例：
  朝ごはんを食べる
  吃早饭

注意：
  • 口语常用
```

### 句子解析（Sentence）
```
📄 句子解析

翻译：
今天好像要下雨

逐词解析：
今日     きょう      今天        时间名词
は       は          (主题标记)  助词
雨       あめ        雨          名词
が       が          (主语标记)  助词
...

语法点：
• は标记主题
• そう表推测
```

### 未收录（NotFound）
```
❓ 未收录

⚠️ 该词条未收录于词典

可能的相近词条：
食べる  たべる
吃，食用
```

## 实现细节

### 模型配置
- OpenAI: `gpt-4o-mini` 或 `gpt-4.1-mini`
- Anthropic: `claude-3-haiku`
- 温度: 0.2（保证确定性）
- 格式: JSON模式
- Max tokens: 512

### 缓存策略
- 内存缓存（NSCache）+ 磁盘缓存
- 缓存键：MD5(query + provider + locale + version)
- 命中缓存时跳过API调用

### 配额控制
- 默认每日限额：50次
- 按日期重置
- 超限时返回 `LLMError.quotaExceeded`

## 测试案例

### 单词查询
| 输入 | 期望输出 |
|------|---------|
| 食べる | 词条：食べる（たべる）動詞 |
| eat | 映射到：食べる、食う、食する |
| 中午 | 映射到：正午、昼 |

### 句子查询
| 输入 | 期望输出 |
|------|---------|
| 今日は雨が降りそうです | 逐词解析 + 语法点 + 整句翻译 |

### 未收录
| 输入 | 期望输出 |
|------|---------|
| asdfgh | 未収录，说明：无效输入 |
| 食べべる | 未収录，候选：食べる |

## 优势对比

### 旧系统（翻译模式）
```json
{
  "direct": "今天下雨",
  "natural": "今天会下雨",
  "points": ["そう表推测"],
  "keywords": [{"term":"雨","reading":"あめ","glossZH":"雨"}]
}
```
❌ 问题：
- 输出格式不统一
- 关键词信息过于简单
- 无词性、用例等完整信息

### 新系统（词典模式）
```json
{
  "queryType": "sentence",
  "entries": [...],
  "sentenceAnalysis": {
    "wordBreakdown": [...],
    "grammar": [...],
    "translation": "..."
  }
}
```
✅ 优势：
- 规范化词典格式
- 完整词条信息（见出し語、読み、品詞、義項、用例）
- 智能识别查询类型
- 支持多语言输入映射

## 未来扩展

1. **词源信息**：添加词源（漢語/和語/外来語）
2. **音调标注**：添加音调信息（東京方言）
3. **活用表**：动词/形容词活用表
4. **关联词**：同义词、反义词、类义词
5. **语境标签**：书面语/口语、敬语程度、使用场景
6. **例句来源**：标注例句出处（文学/新闻/会话）

## 总结

新的AI词典系统将NichiDict的AI功能从简单的翻译工具提升为专业的日语学习助手。通过规范化的词典格式输出、智能的查询类型识别和多语言输入支持，用户可以获得更准确、更专业的日语查询体验。
